---
 - name: create the directory {{ openshift_install_dir }} to store the ignition files
   file:
     path: "{{ openshift_install_dir }}"
     state: directory
     mode: '0755'
     owner: "{{ local_user_account }}"
     group: "{{ local_user_account }}"     
   tags: [ ignitions, deploy_nodes ]

 - name: Create ocp4 install config file {{ openshift_install_dir }}/install-config.yaml
   template:
     src: install-config.yaml.j2
     dest: "{{ openshift_install_dir }}/install-config.yaml"
     owner: "{{ local_user_account }}"
     group: "{{ local_user_account }}"
     mode: '0644'
   when: deploy_ocp4_configs|bool
   tags: [ ignitions, deploy_nodes ]

 - name: stash the generated {{ openshift_install_dir }}/install-config.yaml
   copy:
     src: "{{ openshift_install_dir }}/install-config.yaml"
     dest: "{{ openshift_install_dir }}/install-config.yaml.bkup"
     owner: "{{ local_user_account }}"
     group: "{{ local_user_account }}"
     mode: '0644'
   when: deploy_ocp4_configs|bool
   tags: [ ignitions, deploy_nodes ]

 - name: Generate the Kubernetes manifests for the cluster
   command: "/usr/local/bin/openshift-install --dir={{ openshift_install_dir }} create manifests"
   args:
     creates: "{{ openshift_install_dir }}/manifests/cluster-scheduler-02-config.yml"
   when: deploy_ocp4_configs|bool
   tags: [ ignitions, deploy_nodes, manifests ]
   
 - name: Ensure the openshfit installation directory owned by the admin user 
   file:
     path: "{{ openshift_install_dir }}"
     owner: "{{ local_user_account }}"
     group: "{{ local_user_account }}"
   tags: [ ignitions, deploy_nodes, manifests ]
       
 - name: Mark mastersSchedulable when compute_count is 0
   when: compute_count > 1
   lineinfile:
     path: "{{ openshift_install_dir }}/manifests/cluster-scheduler-02-config.yml"
     regexp: '  mastersSchedulable'
     line: "  mastersSchedulable: false"
   tags: [ ignitions, deploy_nodes, manifests ]   

 - name: Create ignition files
   command: "/usr/local/bin/openshift-install --dir={{ openshift_install_dir }} create ignition-configs; touch {{ openshift_install_dir }}/.igdone"
   args:
     creates: "{{ openshift_install_dir }}/.igdone"
   changed_when: false
   when: deploy_ocp4_configs|bool
   tags: [ ignitions, deploy_nodes ]

 - name: "Recursively change ownership of {{ openshift_install_dir }}"
   file:
     path: "{{ openshift_install_dir }}"
     state: directory
     recurse: yes
     owner: "{{ local_user_account }}"
     group: "{{ local_user_account }}"
   tags: [ ignitions, deploy_nodes ]
